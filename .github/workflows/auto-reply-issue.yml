name: MoltBot - Auto Reply to Issues

on:
  issues:
    types: [opened]

jobs:
  reply_to_issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk

      - name: Auto-reply to issue
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPOSITORY: ${{ github.repository }}
        run: |
          node -e "
          const https = require('https');
          const Anthropic = require('@anthropic-ai/sdk');

          const client = new Anthropic({
            apiKey: process.env.ANTHROPIC_API_KEY
          });

          async function main() {
            const issueContext = \`
          Repository: \${process.env.REPOSITORY}
          Issue #\${process.env.ISSUE_NUMBER}: \${process.env.ISSUE_TITLE}

          Issue Description:
          \${process.env.ISSUE_BODY}
          \`;

            const response = await client.messages.create({
              model: 'claude-3-5-sonnet-20241022',
              max_tokens: 1024,
              system: 'You are a helpful GitHub bot assistant for the Moltbook project. Provide concise, helpful responses to GitHub issues. Be professional and constructive.',
              messages: [
                {
                  role: 'user',
                  content: \`Please provide a helpful response to this GitHub issue:\n\n\${issueContext}\`
                }
              ]
            });

            const reply = response.content[0].text;

            // Post comment to GitHub
            const postData = JSON.stringify({
              body: reply
            });

            const options = {
              hostname: 'api.github.com',
              port: 443,
              path: \`/repos/\${process.env.REPOSITORY}/issues/\${process.env.ISSUE_NUMBER}/comments\`,
              method: 'POST',
              headers: {
                'Authorization': \`token \${process.env.GITHUB_TOKEN}\`,
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData),
                'User-Agent': 'MoltBot'
              }
            };

            return new Promise((resolve, reject) => {
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', (chunk) => { data += chunk; });
                res.on('end', () => {
                  if (res.statusCode >= 200 && res.statusCode < 300) {
                    console.log('âœ“ Comment posted successfully');
                    resolve();
                  } else {
                    reject(new Error(\`GitHub API error: \${res.statusCode}\`));
                  }
                });
              });
              req.on('error', reject);
              req.write(postData);
              req.end();
            });
          }

          main().catch(error => {
            console.error('Error:', error.message);
            process.exit(1);
          });
          "

      - name: Auto-label issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueTitle = context.payload.issue.title.toLowerCase();
            const issueBody = context.payload.issue.body.toLowerCase();
            const fullText = issueTitle + ' ' + issueBody;

            let labels = [];

            if (fullText.includes('bug') || fullText.includes('broken') || fullText.includes('error')) {
              labels.push('bug');
            }
            if (fullText.includes('feature') || fullText.includes('enhancement') || fullText.includes('add')) {
              labels.push('enhancement');
            }
            if (fullText.includes('question') || fullText.includes('how') || fullText.includes('why')) {
              labels.push('question');
            }
            if (fullText.includes('api')) {
              labels.push('api');
            }
            if (fullText.includes('frontend') || fullText.includes('ui') || fullText.includes('design')) {
              labels.push('frontend');
            }
            if (fullText.includes('doc') || fullText.includes('readme') || fullText.includes('guide')) {
              labels.push('documentation');
            }

            if (labels.length === 0) {
              labels.push('needs-triage');
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labels
            });
